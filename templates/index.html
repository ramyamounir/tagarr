<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aliass</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; padding: 16px; max-width: 600px; margin: 0 auto; }
  h1 { font-size: 1.4em; margin-bottom: 16px; color: #7eb8da; }

  .search-box { display: flex; gap: 8px; margin-bottom: 20px; }
  .search-box input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #16213e; color: #e0e0e0; font-size: 16px; }
  .search-box input::placeholder { color: #666; }
  .search-box button { padding: 12px 20px; border-radius: 8px; border: none; background: #0f3460; color: #e0e0e0; font-size: 16px; cursor: pointer; }
  .search-box button:active { background: #1a5276; }

  .series { background: #16213e; border-radius: 10px; padding: 16px; margin-bottom: 14px; }
  .series-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; }
  .series-title { font-size: 1.1em; font-weight: 600; color: #7eb8da; }
  .series-meta { font-size: 0.8em; color: #888; }
  .media-id { font-size: 0.75em; color: #666; font-family: monospace; }

  .badge { display: inline-block; font-size: 0.65em; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-right: 6px; vertical-align: middle; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge-series { background: #1a3a5c; color: #7eb8da; }
  .badge-movie { background: #5c4a1a; color: #dab87e; }

  .alias { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin-bottom: 4px; background: #1a1a2e; border-radius: 6px; }
  .alias-info { flex: 1; min-width: 0; }
  .alias-title { word-break: break-word; }
  .alias-search { font-size: 0.8em; color: #888; }
  .alias-season { font-size: 0.75em; color: #c9a227; margin-left: 6px; }
  .alias-auto { font-size: 0.7em; color: #555; font-style: italic; }
  .alias .remove-btn { background: #5c1a1a; color: #e07070; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px; margin-left: 8px; flex-shrink: 0; }
  .alias .remove-btn:active { background: #7a2020; }

  .no-aliases { color: #555; font-style: italic; font-size: 0.9em; padding: 4px 0; }

  .add-form { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
  .add-form input { flex: 1; min-width: 120px; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #1a1a2e; color: #e0e0e0; font-size: 15px; }
  .add-form button { padding: 10px 16px; border-radius: 6px; border: none; background: #1a5c3a; color: #e0e0e0; font-size: 15px; cursor: pointer; flex-shrink: 0; }
  .add-form button:active { background: #237a4c; }

  .msg { padding: 8px 12px; border-radius: 6px; margin-top: 8px; font-size: 0.85em; }
  .msg-ok { background: #1a3a2a; color: #70e090; }
  .msg-err { background: #3a1a1a; color: #e07070; }

  .empty { text-align: center; color: #555; margin-top: 40px; }
</style>
</head>
<body>

<h1>Aliass</h1>

<div class="search-box">
  <input type="text" id="search" placeholder="Search series and movies..." autofocus>
  <button onclick="doSearch()">Search</button>
</div>

<div id="results"></div>

<script>
const $ = (s) => document.querySelector(s);
const searchInput = $("#search");
const resultsDiv = $("#results");

searchInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") doSearch();
});

function cardKey(item) {
  return `${item.source}-${item.media_id}`;
}

async function doSearch() {
  const q = searchInput.value.trim();
  if (!q) return;
  resultsDiv.innerHTML = '<div class="empty">Searching...</div>';

  const res = await fetch("/api/search?q=" + encodeURIComponent(q));
  const data = await res.json();

  if (data.length === 0) {
    resultsDiv.innerHTML = '<div class="empty">No results found</div>';
    return;
  }

  resultsDiv.innerHTML = data.map(renderCard).join("");
}

function renderCard(item) {
  const key = cardKey(item);
  const year = item.year ? ` (${item.year})` : "";
  const status = item.status ? ` &middot; ${item.status}` : "";
  const badgeClass = item.media_type === "movie" ? "badge-movie" : "badge-series";
  const badgeLabel = item.media_type === "movie" ? "Movie" : "TV";
  const idLabel = item.source === "radarr" ? "TMDB" : "TVDB";

  const aliasesHtml = item.aliases.length === 0
    ? '<div class="no-aliases">No aliases</div>'
    : item.aliases.map(a => renderAlias(a, item.source, key)).join("");

  const seasonInput = item.media_type === "series"
    ? `<input type="text" id="new-season-${key}" placeholder="Season (opt)" style="max-width:90px;flex:0 0 90px;">`
    : "";

  return `
    <div class="series" id="card-${key}">
      <div class="series-header">
        <span class="series-title"><span class="badge ${badgeClass}">${badgeLabel}</span>${esc(item.title)}${year}</span>
        <span class="series-meta">${status}</span>
      </div>
      <div class="media-id">${idLabel}: ${item.media_id}</div>
      <div class="aliases" id="aliases-${key}">
        ${aliasesHtml}
      </div>
      <div class="add-form">
        <input type="text" id="new-alias-${key}" placeholder="New alias...">
        ${seasonInput}
        <button onclick="addAlias('${key}', '${item.source}', ${item.media_id}, ${item.metadata_id || 'null'})">Add</button>
      </div>
      <div id="msg-${key}"></div>
    </div>`;
}

function renderAlias(a, source, key) {
  const searchInfo = a.search_term && a.search_term !== a.title
    ? `<div class="alias-search">searches: ${esc(a.search_term)}</div>` : "";
  const season = a.season !== null && a.season !== undefined ? `<span class="alias-season">S${a.season}</span>` : "";
  const removeBtn = a.manual
    ? `<button class="remove-btn" onclick="removeAlias(${a.id}, '${source}', '${key}')">Remove</button>` : "";
  const autoTag = !a.manual ? '<span class="alias-auto"> (auto)</span>' : "";

  return `
    <div class="alias" id="alias-${source}-${a.id}">
      <div class="alias-info">
        <span class="alias-title">${esc(a.title)}${season}${autoTag}</span>
        ${searchInfo}
      </div>
      ${removeBtn}
    </div>`;
}

async function addAlias(key, source, mediaId, metadataId) {
  const input = $(`#new-alias-${key}`);
  const title = input.value.trim();
  if (!title) return;

  let body;
  if (source === "radarr") {
    body = { source: "radarr", metadata_id: metadataId, title };
  } else {
    const seasonInput = $(`#new-season-${key}`);
    const season = seasonInput ? seasonInput.value.trim() : "";
    body = { source: "sonarr", tvdb_id: mediaId, title };
    if (season !== "") body.season = parseInt(season, 10);
  }

  const res = await fetch("/api/alias", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });
  const data = await res.json();

  if (data.error) {
    showMsg(key, data.error, true);
    return;
  }

  input.value = "";
  showMsg(key, `Added "${title}"`, false);
  doSearch();
}

async function removeAlias(aliasId, source, key) {
  const res = await fetch(`/api/alias/${aliasId}?source=${source}`, { method: "DELETE" });
  const data = await res.json();

  if (data.error) {
    showMsg(key, data.error, true);
    return;
  }

  showMsg(key, "Removed", false);
  doSearch();
}

function showMsg(key, text, isError) {
  const el = $(`#msg-${key}`);
  el.innerHTML = `<div class="msg ${isError ? "msg-err" : "msg-ok"}">${esc(text)}</div>`;
  setTimeout(() => { el.innerHTML = ""; }, 3000);
}

function esc(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
